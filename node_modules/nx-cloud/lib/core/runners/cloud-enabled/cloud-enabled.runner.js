const a1_0x3ef0=['writeFileSync','toISOString','complete','Nx\x20Cloud\x20wasn\x27t\x20able\x20to\x20record\x20its\x20run.','maskedProperties','obfuscate','ENCRYPTION_KEY','E2EEncryption','catch','resolve','value','parseCommand','note','submitRunMetrics','storedHashes','map','./cloud-run.api','Executed\x20tasks\x20with\x20hashes:\x20','../../../utilities/environment','CloudEnabledLifeCycle','lifeCycle','assign','fs-extra','cacheableOperations','VERBOSE_LOGGING','skipNxCache','done','requests','\x20isn\x27t\x20recorded','length','env','../../../utilities/metric-logger','filter','anyErrors','taskId','../../terminal-output/output-obfuscator','cloud-enabled-runner','NX_CLOUD_DISTRIBUTED_EXECUTION_ID','CloudRemoteCache','url','./id-generator','../../file-storage/e2e-encryption','/runs/','pathExists','join','enabled','runUrl','uploadedToStorage','processInBackground','then','Nx\x20Cloud\x20Problems','cacheStatus','EndOfRunMessage','push','removeTrailingSlash','defineProperty','getCIExecutionId','../../terminal-output/end-of-run-message','getBranch','ACCESS_TOKEN','path','https://nx.app','hash','./cloud-enabled-life-cycle','endRun','subscribe','exit','store','ErrorReporterApi','next','apply','CloudRunApi','printMessages','../../../utilities/remove-trailing-slash','all','getRunGroup','FileStorage','printCacheHitsMessage','cloudEnabledTasksRunner','Task\x20with\x20hash\x20','error','agentRunningInDistributedExecution','encryptionKey','local-cache-hit','__awaiter','warn','tasks-hashes-','../../api/error-reporter.api','DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE','daemon','stringify'];(function(_0x5852c8,_0x3ef063){const _0x2aa33c=function(_0x450f76){while(--_0x450f76){_0x5852c8['push'](_0x5852c8['shift']());}};_0x2aa33c(++_0x3ef063);}(a1_0x3ef0,0x1d7));const a1_0x2aa3=function(_0x5852c8,_0x3ef063){_0x5852c8=_0x5852c8-0x0;let _0x2aa33c=a1_0x3ef0[_0x5852c8];return _0x2aa33c;};'use strict';var __awaiter=this&&this[a1_0x2aa3('0x44')]||function(_0x310049,_0x1d2228,_0x4f3c19,_0x193ec5){function _0x267999(_0x1b7dd1){return _0x1b7dd1 instanceof _0x4f3c19?_0x1b7dd1:new _0x4f3c19(function(_0x4d9992){_0x4d9992(_0x1b7dd1);});}return new(_0x4f3c19||(_0x4f3c19=Promise))(function(_0xa83d3f,_0x3cf874){function _0x3fcfb7(_0x1ce221){try{_0xc7357(_0x193ec5['next'](_0x1ce221));}catch(_0x1e2d0d){_0x3cf874(_0x1e2d0d);}}function _0x56913d(_0x5baf6d){try{_0xc7357(_0x193ec5['throw'](_0x5baf6d));}catch(_0x514f82){_0x3cf874(_0x514f82);}}function _0xc7357(_0x20ac6d){_0x20ac6d[a1_0x2aa3('0xa')]?_0xa83d3f(_0x20ac6d[a1_0x2aa3('0x55')]):_0x267999(_0x20ac6d[a1_0x2aa3('0x55')])[a1_0x2aa3('0x21')](_0x3fcfb7,_0x56913d);}_0xc7357((_0x193ec5=_0x193ec5[a1_0x2aa3('0x36')](_0x310049,_0x1d2228||[]))[a1_0x2aa3('0x35')]());});};Object[a1_0x2aa3('0x27')](exports,'__esModule',{'value':!![]});exports[a1_0x2aa3('0x3e')]=void 0x0;const message_reporter_1=require('../../terminal-output/message-reporter');const end_of_run_message_1=require(a1_0x2aa3('0x29'));const output_obfuscator_1=require(a1_0x2aa3('0x13'));const cloud_enabled_life_cycle_1=require(a1_0x2aa3('0x2f'));const file_storage_1=require('../../file-storage/file-storage');const e2e_encryption_1=require(a1_0x2aa3('0x19'));const environment_1=require(a1_0x2aa3('0x2'));const cloud_remote_cache_1=require('./cloud-remote-cache');const cloud_run_api_1=require(a1_0x2aa3('0x0'));const fs_1=require('fs');const path=require(a1_0x2aa3('0x2c'));const path_1=require('path');const metric_logger_1=require(a1_0x2aa3('0xf'));const error_reporter_api_1=require(a1_0x2aa3('0x47'));const fs_extra_1=require(a1_0x2aa3('0x6'));const id_generator_1=require(a1_0x2aa3('0x18'));const remove_trailing_slash_1=require(a1_0x2aa3('0x39'));const {tasksRunner,output,cacheDirectory}=require('../../../utilities/nx-imports');function createApi(_0x5eda0b,_0x2deb2f,_0x287a89){const _0x2b3655=(0x0,environment_1['getMachineInfo'])(_0x2deb2f);return new cloud_run_api_1[(a1_0x2aa3('0x37'))](_0x5eda0b,_0x287a89,_0x2deb2f,_0x2b3655);}function storeTaskHashes(_0x5f0f2d,_0x3623c1,_0x4cad69){const _0x35f5c0=JSON[a1_0x2aa3('0x4a')](_0x5f0f2d[a1_0x2aa3('0x5a')](_0x4ccc7b=>({'taskId':_0x4ccc7b[a1_0x2aa3('0x12')],'hash':_0x4ccc7b[a1_0x2aa3('0x2e')]})));if(environment_1[a1_0x2aa3('0x8')]){output[a1_0x2aa3('0x57')]({'title':a1_0x2aa3('0x1')+_0x35f5c0});}(0x0,fs_1[a1_0x2aa3('0x4b')])(path[a1_0x2aa3('0x1c')](_0x3623c1,a1_0x2aa3('0x46')+_0x4cad69),_0x35f5c0);}function storeLocalCacheHits(_0x413230,_0x502781,_0x42380b){const _0xcd1730=_0x413230[a1_0x2aa3('0x10')](_0x21fa49=>_0x21fa49[a1_0x2aa3('0x23')]===a1_0x2aa3('0x43'))[a1_0x2aa3('0x5a')](_0x26a00b=>_0x26a00b[a1_0x2aa3('0x2e')]);_0xcd1730['forEach'](_0x36a4f0=>_0x502781[a1_0x2aa3('0x33')](_0x36a4f0,_0x42380b));}function onComplete({daemon,options,fileStorage,remoteCache,api,outputObfuscator,runStartTime,messages,endOfRunMessage,taskExecutions,versionOfNxBefore133,inner,encryptionKey,storeInCurrentProcess,distributedExecutionId,runContext}){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x5a8948=new Date()[a1_0x2aa3('0x4c')]();const _0x519afa=(0x0,environment_1[a1_0x2aa3('0x2a')])();const _0x8c0cfe={'command':outputObfuscator[a1_0x2aa3('0x50')]((0x0,environment_1[a1_0x2aa3('0x56')])()),'startTime':runStartTime,'endTime':_0x5a8948,'distributedExecutionId':distributedExecutionId,'branch':_0x519afa,'runGroup':(0x0,environment_1[a1_0x2aa3('0x3b')])(),'sha':_0x519afa?(0x0,environment_1['extractGitSha'])():undefined,'inner':inner};const _0x5e85d6={'branch':_0x519afa,'runGroup':(0x0,environment_1[a1_0x2aa3('0x3b')])(),'ciExecutionId':(0x0,environment_1[a1_0x2aa3('0x28')])(),'ciExecutionEnv':(0x0,environment_1['getCIExecutionEnv'])()};if(storeInCurrentProcess){if((0x0,environment_1[a1_0x2aa3('0x41')])(distributedExecutionId)){storeTaskHashes(taskExecutions,cacheDirectory,distributedExecutionId);storeLocalCacheHits(taskExecutions,remoteCache,cacheDirectory);}try{yield remoteCache['waitForStoreRequestsToComplete']();}catch(_0x4ffc78){output[a1_0x2aa3('0x40')]({'title':'Nx\x20Cloud\x20wasn\x27t\x20able\x20to\x20store\x20artifacts.'});messages['printMessages']();return![];}for(const _0xfc5714 of fileStorage[a1_0x2aa3('0x59')]){const _0x466884=taskExecutions['find'](_0x3af236=>_0x3af236[a1_0x2aa3('0x2e')]===_0xfc5714);if(!_0x466884){throw new Error(a1_0x2aa3('0x3f')+_0xfc5714+a1_0x2aa3('0xc'));}_0x466884[a1_0x2aa3('0x1f')]=!![];}try{yield api[a1_0x2aa3('0x30')](_0x8c0cfe,taskExecutions,_0x5e85d6);}catch(_0x4e742e){output[a1_0x2aa3('0x40')]({'title':a1_0x2aa3('0x4e')});messages[a1_0x2aa3('0x38')]();return![];}yield(0x0,metric_logger_1[a1_0x2aa3('0x58')])(options);}else{try{const _0x5646c0=environment_1['ACCESS_TOKEN']?environment_1[a1_0x2aa3('0x2b')]:options['accessToken'];const _0x450009=(0x0,id_generator_1['generateUniqueLinkId'])();const _0xd8eda9=require[a1_0x2aa3('0x54')]('nx-cloud/lib/daemon/process-run-end');yield daemon[a1_0x2aa3('0x20')](_0xd8eda9,{'encryptionKey':encryptionKey,'runnerOptions':Object['assign'](Object['assign']({},options),{'accessToken':_0x5646c0}),'delayedStoreRequests':remoteCache['delayedStoreRequests'],'ciExecutionContext':_0x5e85d6,'runEnd':{'runData':_0x8c0cfe,'taskExecutions':taskExecutions,'linkId':_0x450009}});runContext[a1_0x2aa3('0x1e')]=(0x0,remove_trailing_slash_1[a1_0x2aa3('0x26')])(options[a1_0x2aa3('0x17')]||a1_0x2aa3('0x2d'))+a1_0x2aa3('0x1a')+_0x450009;}catch(_0x45c0c8){output[a1_0x2aa3('0x45')]({'title':a1_0x2aa3('0x22'),'bodyLines':[_0x45c0c8['message']||_0x45c0c8['toString']()]});return![];}}if(versionOfNxBefore133){setTimeout(()=>{messages[a1_0x2aa3('0x38')]();if(!messages[a1_0x2aa3('0x11')]&&!inner){endOfRunMessage['printCacheHitsMessage']();}},0x0);}else{messages[a1_0x2aa3('0x38')]();if(!messages[a1_0x2aa3('0x11')]&&!inner){endOfRunMessage[a1_0x2aa3('0x3d')]();}}return!![];});}function createLifeCycle(_0x502647,_0x1c9997,_0x4e101f,_0x29c5c4){const _0x4ede55=new cloud_enabled_life_cycle_1[(a1_0x2aa3('0x3'))](_0x502647,cacheDirectory,!![],_0x1c9997[a1_0x2aa3('0x7')]||[],_0x4e101f,_0x29c5c4);try{const {CompositeLifeCycle}=require('../../../utilities/nx-imports');if(!CompositeLifeCycle)return _0x4ede55;return new CompositeLifeCycle([_0x1c9997[a1_0x2aa3('0x4')],_0x4ede55]);}catch(_0x297fbc){return _0x4ede55;}}function fetchUrlsForKnownHashesUpfront(_0x2ce1de,_0x4a0e48,_0x16bacc,_0xe80182,_0x20ac3e){return __awaiter(this,void 0x0,void 0x0,function*(){if(_0xe80182[a1_0x2aa3('0x9')])return;let _0x4a5609=_0x16bacc[a1_0x2aa3('0x5a')](_0x2cde36=>_0x2cde36[a1_0x2aa3('0x2e')])[a1_0x2aa3('0x10')](_0x2d0506=>!!_0x2d0506);const _0x1a92c6=yield Promise[a1_0x2aa3('0x3a')](_0x4a5609[a1_0x2aa3('0x5a')](_0x5e098a=>{const _0x5cd19b=(0x0,path_1[a1_0x2aa3('0x1c')])(cacheDirectory,_0x5e098a+'.commit');return(0x0,fs_extra_1[a1_0x2aa3('0x1b')])(_0x5cd19b);}));const _0x13ec19=[];for(let _0x37c704=0x0;_0x37c704<_0x1a92c6[a1_0x2aa3('0xd')];++_0x37c704){if(!_0x1a92c6[_0x37c704]){_0x13ec19[a1_0x2aa3('0x25')](_0x4a5609[_0x37c704]);}}if(_0x13ec19[a1_0x2aa3('0xd')]>0x0){const _0x5a9555=_0x2ce1de['startRun'](_0x20ac3e,_0x13ec19);for(const _0x1eb3c4 of _0x13ec19){_0x4a0e48[a1_0x2aa3('0xb')][_0x1eb3c4]=_0x5a9555;}}});}function cloudEnabledTasksRunner(_0x1430ad,_0x42c51c,_0x6e141,_0x1d6194=![]){var _0x43fb12;const _0x38bb1f=process['env'][a1_0x2aa3('0x15')];const _0x4fc62d={'statuses':{},'scheduledTasks':[],'requests':{},'allTasks':_0x1430ad};const _0x565829=_0x42c51c[a1_0x2aa3('0x4')]===undefined;const _0x552860=[];const _0x22890c=new message_reporter_1['MessageReporter'](_0x42c51c);const _0x2a88b4=createApi(_0x22890c,_0x42c51c,_0x4fc62d);const _0x130bbb=new end_of_run_message_1[(a1_0x2aa3('0x24'))](_0x4fc62d,_0x552860,_0x38bb1f);const _0x559e82=new output_obfuscator_1['OutputObfuscator'](_0x42c51c[a1_0x2aa3('0x4f')]);const _0xc555f1=new Date()[a1_0x2aa3('0x4c')]();const _0x175b45=createLifeCycle(_0x4fc62d,_0x42c51c,_0x559e82,_0x552860);const _0x1613ea=environment_1[a1_0x2aa3('0x51')]||_0x42c51c[a1_0x2aa3('0x42')];const _0x429c1b=new e2e_encryption_1[(a1_0x2aa3('0x52'))](_0x1613ea);const _0x1745d1=new error_reporter_api_1[(a1_0x2aa3('0x34'))](_0x42c51c);const _0x3a5b7f=(0x0,environment_1['agentRunningInDistributedExecution'])(_0x38bb1f)||!((_0x43fb12=_0x6e141[a1_0x2aa3('0x49')])===null||_0x43fb12===void 0x0?void 0x0:_0x43fb12[a1_0x2aa3('0x1d')]());const _0x1ab1ef=new file_storage_1[(a1_0x2aa3('0x3c'))](_0x429c1b,_0x1745d1,_0x42c51c,a1_0x2aa3('0x14'));const _0x1dfb5f=new cloud_remote_cache_1[(a1_0x2aa3('0x16'))](_0x22890c,_0x2a88b4,_0x4fc62d,_0x1ab1ef,_0x38bb1f,_0x3a5b7f);fetchUrlsForKnownHashesUpfront(_0x2a88b4,_0x4fc62d,_0x1430ad,_0x42c51c,_0x38bb1f);delete process[a1_0x2aa3('0xe')][a1_0x2aa3('0x15')];const _0x3ad5b6=tasksRunner(_0x1430ad,Object['assign'](Object[a1_0x2aa3('0x5')]({},_0x42c51c),{'remoteCache':_0x1dfb5f,'lifeCycle':_0x175b45}),_0x6e141);if(_0x3ad5b6['subscribe']){const {Subject}=require('rxjs/internal/Subject');const _0x388061=new Subject();_0x3ad5b6[a1_0x2aa3('0x31')]({'next':_0x28d336=>_0x388061[a1_0x2aa3('0x35')](_0x28d336),'error':_0x146a16=>_0x388061[a1_0x2aa3('0x40')](_0x146a16),'complete':()=>__awaiter(this,void 0x0,void 0x0,function*(){const _0x3b7315=yield onComplete({'daemon':_0x6e141[a1_0x2aa3('0x49')],'options':_0x42c51c,'fileStorage':_0x1ab1ef,'remoteCache':_0x1dfb5f,'api':_0x2a88b4,'outputObfuscator':_0x559e82,'runStartTime':_0xc555f1,'messages':_0x22890c,'endOfRunMessage':_0x130bbb,'taskExecutions':_0x552860,'versionOfNxBefore133':_0x565829,'inner':_0x1d6194,'encryptionKey':_0x1613ea,'storeInCurrentProcess':_0x3a5b7f,'runContext':_0x4fc62d,'distributedExecutionId':_0x38bb1f});if(!_0x3b7315&&(0x0,environment_1[a1_0x2aa3('0x41')])(_0x38bb1f)){process['exit'](environment_1[a1_0x2aa3('0x48')]);}_0x388061[a1_0x2aa3('0x4d')]();})});return _0x388061;}else{return _0x3ad5b6[a1_0x2aa3('0x21')](_0x305bf6=>__awaiter(this,void 0x0,void 0x0,function*(){const _0xd66f6=yield onComplete({'daemon':_0x6e141[a1_0x2aa3('0x49')],'options':_0x42c51c,'fileStorage':_0x1ab1ef,'remoteCache':_0x1dfb5f,'api':_0x2a88b4,'outputObfuscator':_0x559e82,'runStartTime':_0xc555f1,'messages':_0x22890c,'endOfRunMessage':_0x130bbb,'taskExecutions':_0x552860,'versionOfNxBefore133':_0x565829,'inner':_0x1d6194,'encryptionKey':_0x1613ea,'storeInCurrentProcess':_0x3a5b7f,'runContext':_0x4fc62d,'distributedExecutionId':_0x38bb1f});if(!_0xd66f6&&(0x0,environment_1[a1_0x2aa3('0x41')])(_0x38bb1f)){process[a1_0x2aa3('0x32')](environment_1[a1_0x2aa3('0x48')]);}return _0x305bf6;}))[a1_0x2aa3('0x53')](_0x2ef44a=>__awaiter(this,void 0x0,void 0x0,function*(){const _0x1c04c2=yield onComplete({'daemon':_0x6e141[a1_0x2aa3('0x49')],'options':_0x42c51c,'fileStorage':_0x1ab1ef,'remoteCache':_0x1dfb5f,'api':_0x2a88b4,'outputObfuscator':_0x559e82,'runStartTime':_0xc555f1,'messages':_0x22890c,'endOfRunMessage':_0x130bbb,'taskExecutions':_0x552860,'versionOfNxBefore133':_0x565829,'inner':_0x1d6194,'encryptionKey':_0x1613ea,'storeInCurrentProcess':_0x3a5b7f,'runContext':_0x4fc62d,'distributedExecutionId':_0x38bb1f});if(!_0x1c04c2&&(0x0,environment_1[a1_0x2aa3('0x41')])(_0x38bb1f)){process[a1_0x2aa3('0x32')](environment_1[a1_0x2aa3('0x48')]);}throw _0x2ef44a;}));}}exports['cloudEnabledTasksRunner']=cloudEnabledTasksRunner;