const a6_0x3b6c=['then','CIRCLE_STAGE','tasksRunnerOptions','printRunGroupError','E2EEncryption','../../error/print-cacheable-targets-error','Agent\x20was\x20terminated\x20via\x20SIGTERM','printCacheableTargetsError','SIGTERM','Nx\x20Cloud:\x20Workspace\x20is\x20disabled','./execute-tasks','unlinkSync','includes','mkdirSync','Distributed\x20Task\x20Execution\x20is\x20disabled\x20when\x20your\x20workspace\x20is\x20disabled','completeRunGroupWithError','Duplicate\x20Agent\x20ID\x20Detected','filter','This\x20can\x20also\x20be\x20a\x20false\x20positive\x20caused\x20by\x20agents\x20that\x20did\x20not\x20shut\x20down\x20correctly.','join','If\x20you\x20believe\x20this\x20is\x20the\x20case,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22.','defineProperty','submitRunMetrics','ENCRYPTION_KEY','readdirSync','warn','yargs-parser','cacheableOperations','strip-json-comments','existsSync','value','nx-cloud','writeFileSync','Agent\x20was\x20terminated\x20via\x20SIGINT','../../../utilities/nx-imports','canDetectRunGroup','next','../../error/print-invalid-runner-error','startAgent','printInvalidRunnerError','invokeTasksUsingNxImperativeApi','toString','../../../utilities/is-workspace-enabled','default','CIRCLE_JOB','./invoke-tasks-using-nx-imperative-api','../../../utilities/metric-logger','invokeTasksUsingRunMany','getCIExecutionEnv','__esModule','../../../utilities/environment','catch','error','../../../utilities/dte-artifact-storage','done','Agent\x20','parse','random','.lock','split','targets','SIGINT','/nx.json','../../file-storage/e2e-encryption','@nrwl/nx-cloud','throw','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20target(s)\x20[','length','Organization\x20administrators\x20can\x20find\x20more\x20information\x20on\x20the\x20\x27Billing\x20and\x20Plans\x27\x20page\x20in\x20the\x20Nx\x20Cloud\x20Webapp','env','../../error/print-run-group-error','map','executeTasks','floor','exit','NX_AGENT_NAME','Critical\x20Error\x20in\x20Agent:\x20\x22','ErrorReporterApi','./invoke-tasks-using-run-many','FileStorage','./distributed-agent.api','trim','runner','message','argv','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20tasks','CIRCLECI','dte-agent','We\x20have\x20detected\x20other\x20agents\x20running\x20in\x20this\x20workspace.\x20This\x20can\x20cause\x20unexpected\x20behavior.'];(function(_0x47e414,_0x3b6c19){const _0x32fc67=function(_0x54a38f){while(--_0x54a38f){_0x47e414['push'](_0x47e414['shift']());}};_0x32fc67(++_0x3b6c19);}(a6_0x3b6c,0x192));const a6_0x32fc=function(_0x47e414,_0x3b6c19){_0x47e414=_0x47e414-0x0;let _0x32fc67=a6_0x3b6c[_0x47e414];return _0x32fc67;};'use strict';var __awaiter=this&&this['__awaiter']||function(_0x23c079,_0x3b7478,_0x2d9ef5,_0x9da9a6){function _0x4352ab(_0x362b67){return _0x362b67 instanceof _0x2d9ef5?_0x362b67:new _0x2d9ef5(function(_0xe0f2a1){_0xe0f2a1(_0x362b67);});}return new(_0x2d9ef5||(_0x2d9ef5=Promise))(function(_0x548239,_0x28bb13){function _0x25c05e(_0x1429ee){try{_0x468bcd(_0x9da9a6[a6_0x32fc('0x4f')](_0x1429ee));}catch(_0x38ba9b){_0x28bb13(_0x38ba9b);}}function _0x49f5e0(_0x80810c){try{_0x468bcd(_0x9da9a6[a6_0x32fc('0x13')](_0x80810c));}catch(_0xbd57ec){_0x28bb13(_0xbd57ec);}}function _0x468bcd(_0x47871f){_0x47871f[a6_0x32fc('0x8')]?_0x548239(_0x47871f[a6_0x32fc('0x49')]):_0x4352ab(_0x47871f['value'])[a6_0x32fc('0x2b')](_0x25c05e,_0x49f5e0);}_0x468bcd((_0x9da9a6=_0x9da9a6['apply'](_0x23c079,_0x3b7478||[]))[a6_0x32fc('0x4f')]());});};Object[a6_0x32fc('0x40')](exports,a6_0x32fc('0x3'),{'value':!![]});exports['startAgent']=void 0x0;const fs_1=require('fs');const stripJsonComments=require(a6_0x32fc('0x47'));const yargsParser=require(a6_0x32fc('0x45'));const environment_1=require(a6_0x32fc('0x4'));const metric_logger_1=require(a6_0x32fc('0x0'));const print_cacheable_targets_error_1=require(a6_0x32fc('0x30'));const print_invalid_runner_error_1=require(a6_0x32fc('0x50'));const print_run_group_error_1=require(a6_0x32fc('0x18'));const distributed_agent_api_1=require(a6_0x32fc('0x22'));const execute_tasks_1=require(a6_0x32fc('0x35'));const dte_artifact_storage_1=require(a6_0x32fc('0x7'));const file_storage_1=require('../../file-storage/file-storage');const e2e_encryption_1=require(a6_0x32fc('0x11'));const error_reporter_api_1=require('../../api/error-reporter.api');const invoke_tasks_using_run_many_1=require(a6_0x32fc('0x20'));const invoke_tasks_using_nx_imperative_api_1=require(a6_0x32fc('0x58'));const is_workspace_enabled_1=require(a6_0x32fc('0x55'));const {output,initTasksRunner,workspaceRoot,cacheDirectory}=require(a6_0x32fc('0x4d'));const args=yargsParser(process[a6_0x32fc('0x26')],{'array':[a6_0x32fc('0xe')],'default':{}});if(args['targets']&&args[a6_0x32fc('0xe')][a6_0x32fc('0x15')]===0x1){args[a6_0x32fc('0xe')]=args[a6_0x32fc('0xe')][0x0][a6_0x32fc('0xd')](',')[a6_0x32fc('0x19')](_0x3fce66=>_0x3fce66[a6_0x32fc('0x23')]());}function startAgent(){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x13246a=(0x0,environment_1['getBranch'])();const _0x238e96=(0x0,environment_1['getRunGroup'])();const _0x25bdaf=(0x0,environment_1['getCIExecutionId'])();const _0x2e5cd1=(0x0,environment_1[a6_0x32fc('0x2')])();if(!(0x0,print_run_group_error_1[a6_0x32fc('0x4e')])(_0x238e96,_0x25bdaf)){(0x0,print_run_group_error_1[a6_0x32fc('0x2e')])();process['exit'](0x1);}if(args[a6_0x32fc('0xe')]&&args[a6_0x32fc('0xe')][a6_0x32fc('0x15')]){output['note']({'title':a6_0x32fc('0x14')+args['targets'][a6_0x32fc('0x3e')](',\x20')+']'});}else{output['note']({'title':a6_0x32fc('0x27')});}const _0x298353=JSON[a6_0x32fc('0xa')](stripJsonComments((0x0,fs_1['readFileSync'])(workspaceRoot+a6_0x32fc('0x10'))[a6_0x32fc('0x54')]()))[a6_0x32fc('0x2d')][a6_0x32fc('0x56')];if(_0x298353['runner']!==a6_0x32fc('0x4a')&&_0x298353[a6_0x32fc('0x24')]!==a6_0x32fc('0x12')){(0x0,print_invalid_runner_error_1[a6_0x32fc('0x52')])();return process[a6_0x32fc('0x1c')](0x1);}const _0x1354de=_0x298353['options'];if(args['targets']&&args['targets']['some'](_0x4c4f53=>{var _0x12ee93;return!((_0x12ee93=_0x1354de[a6_0x32fc('0x46')])===null||_0x12ee93===void 0x0?void 0x0:_0x12ee93['includes'](_0x4c4f53));})){const _0x31fcf6=args[a6_0x32fc('0xe')][a6_0x32fc('0x3c')](_0x235943=>{var _0x3eac16;return!((_0x3eac16=_0x1354de[a6_0x32fc('0x46')])===null||_0x3eac16===void 0x0?void 0x0:_0x3eac16[a6_0x32fc('0x37')](_0x235943));});(0x0,print_cacheable_targets_error_1[a6_0x32fc('0x32')])(_0x31fcf6);return process[a6_0x32fc('0x1c')](0x1);}const _0x428fe9=yield(0x0,is_workspace_enabled_1['isWorkspaceEnabled'])(_0x1354de);if(!_0x428fe9){output[a6_0x32fc('0x6')]({'title':a6_0x32fc('0x34'),'bodyLines':[a6_0x32fc('0x39'),'',a6_0x32fc('0x16')]});process[a6_0x32fc('0x1c')](0x1);}const _0x386318=getAgentName();const _0x4cbe34=new distributed_agent_api_1['DistributedAgentApi'](_0x1354de,_0x13246a,_0x238e96,_0x25bdaf,_0x2e5cd1,_0x386318);createAgentLockfileAndSetUpListeners(_0x4cbe34,_0x1354de,_0x386318);const _0x1ffdc7=new e2e_encryption_1[(a6_0x32fc('0x2f'))](environment_1[a6_0x32fc('0x42')]||_0x1354de['encryptionKey']);const _0x4d7082=new error_reporter_api_1[(a6_0x32fc('0x1f'))](_0x1354de);const _0x447af7=new dte_artifact_storage_1['DteArtifactStorage'](new file_storage_1[(a6_0x32fc('0x21'))](_0x1ffdc7,_0x4d7082,_0x1354de,a6_0x32fc('0x29')),cacheDirectory);const _0x51c118=initTasksRunner?yield(0x0,invoke_tasks_using_nx_imperative_api_1[a6_0x32fc('0x53')])(_0x1354de):yield(0x0,invoke_tasks_using_run_many_1[a6_0x32fc('0x1')])();return(0x0,execute_tasks_1[a6_0x32fc('0x1a')])(_0x386318,_0x4cbe34,_0x447af7,_0x51c118,args[a6_0x32fc('0xe')])['then'](_0x4a37f1=>__awaiter(this,void 0x0,void 0x0,function*(){yield(0x0,metric_logger_1[a6_0x32fc('0x41')])(_0x1354de);return _0x4a37f1;}))[a6_0x32fc('0x5')](_0x1c9621=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x4cbe34[a6_0x32fc('0x3a')](a6_0x32fc('0x1e')+_0x1c9621[a6_0x32fc('0x25')]+'\x22');throw _0x1c9621;}));});}exports[a6_0x32fc('0x51')]=startAgent;function getAgentName(){if(process[a6_0x32fc('0x17')][a6_0x32fc('0x1d')]!==undefined){return process[a6_0x32fc('0x17')][a6_0x32fc('0x1d')];}else if(process['env'][a6_0x32fc('0x28')]!==undefined&&process[a6_0x32fc('0x17')][a6_0x32fc('0x2c')]){return process[a6_0x32fc('0x17')][a6_0x32fc('0x2c')];}else if(process[a6_0x32fc('0x17')]['CIRCLECI']!==undefined&&process[a6_0x32fc('0x17')][a6_0x32fc('0x57')]){return process[a6_0x32fc('0x17')][a6_0x32fc('0x57')];}else{return a6_0x32fc('0x9')+Math[a6_0x32fc('0x1b')](Math[a6_0x32fc('0xb')]()*0x186a0);}}function createAgentLockfileAndSetUpListeners(_0x1b1fee,_0x3279bd,_0x2649a3){const _0x37a7a6=cacheDirectory+'/lockfiles';const _0x220026=_0x37a7a6+'/'+_0x2649a3+a6_0x32fc('0xc');if(!(0x0,fs_1[a6_0x32fc('0x48')])(_0x37a7a6)){(0x0,fs_1[a6_0x32fc('0x38')])(_0x37a7a6,{'recursive':!![]});}const _0x4ee80b=(0x0,fs_1[a6_0x32fc('0x43')])(_0x37a7a6);if(_0x4ee80b[a6_0x32fc('0x15')]){if(_0x4ee80b[a6_0x32fc('0x37')](_0x2649a3+a6_0x32fc('0xc'))){output[a6_0x32fc('0x6')]({'title':a6_0x32fc('0x3b'),'bodyLines':['We\x20have\x20detected\x20another\x20agent\x20with\x20this\x20ID\x20running\x20in\x20this\x20workspace.\x20This\x20should\x20not\x20happen.','','End\x20all\x20currently\x20running\x20agents,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22,\x20and\x20try\x20again.']});process[a6_0x32fc('0x1c')](0x1);}output[a6_0x32fc('0x44')]({'title':'Other\x20Nx\x20Cloud\x20Agents\x20Detected','bodyLines':[a6_0x32fc('0x2a'),'',a6_0x32fc('0x3d'),a6_0x32fc('0x3f')]});}(0x0,fs_1[a6_0x32fc('0x4b')])(_0x220026,'');process['on'](a6_0x32fc('0x1c'),_0x3683f1=>{cleanupAgentLockfile(_0x220026,_0x3683f1);});process['on'](a6_0x32fc('0x33'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x1b1fee['completeRunGroupWithError'](a6_0x32fc('0x31'));cleanupAgentLockfile(_0x220026,0x1);}));process['on'](a6_0x32fc('0xf'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x1b1fee['completeRunGroupWithError'](a6_0x32fc('0x4c'));cleanupAgentLockfile(_0x220026,0x1);}));}function cleanupAgentLockfile(_0x4ec02f,_0x400a11){if((0x0,fs_1[a6_0x32fc('0x48')])(_0x4ec02f)){(0x0,fs_1[a6_0x32fc('0x36')])(_0x4ec02f);process[a6_0x32fc('0x1c')](_0x400a11);}}